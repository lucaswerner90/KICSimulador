angular.module("simuladorKIC",["ui.router"]);var app=angular.module("simuladorKIC");app.config(["$locationProvider","$stateProvider","$urlRouterProvider",function(o,a,c){c.otherwise("/"),a.state("home",{url:"/",templateUrl:"templates/main.html",controller:"mainController"})}]),app.factory("calculoFactory",function(){var o={},a=26;o.energy_consumption_kwh=[],o.energy_consumption_eur=[],o.investment=0,o.decommissioning=[],o.energy_generation_mwh=[],o.gross_income=[],o.gross_income[0]="",o.o_m_cost=[],o.o_m_cost[0]="",o.anual_repayment_interest=0,o.balance=[],o.interests=[],o.repayment=[],o.anual_repayment_interest_conditional=[],o.anual_repayment_interest_conditional[0]="",o.production_consumptions_cost=[],o.project_return=[],o.taxes=[],o.loan_interest=[],o.net_income_with_project=[],o.net_income_wo_project=[],o.total_cash_flow_with_project=[],o.total_cash_flow_wo_project=[],o.project_cashflow=[],o.cumulated_project_economy=[],o.test_payback_year=[],o.consumption_negative=[],o.electricity_bill_with_bipv=[],o.electricity_bill_with_bipv[0]="",o.electricity_bill_wo_bipv=[],o.electricity_bill_wo_bipv[0]="",o.inflation_rate_energy_cost=0;var c={calcularOutputs:function(c){var i=function(){c.bank.debt_financing=parseInt(c.bank.debt_financing)/100,c.bank.loan_interest_rate=parseInt(c.bank.loan_interest_rate)/100,c.bank.load_duration=parseInt(c.bank.load_duration),c.installation.investment_bipv=parseInt(c.installation.investment_bipv),c.installation.tamano=parseInt(c.installation.tamano),c.installation.full_hours=parseInt(c.installation.full_hours),c.installation.degradation=c.installation.degradation/100,c.installation.opex=c.installation.opex/100,c.regulation.inflation=parseInt(c.regulation.inflation)/100,c.regulation.energy_consumed=parseInt(c.regulation.energy_consumed),c.regulation.tax_rate=parseInt(c.regulation.tax_rate)/100},e=function(){c.bank.debt_financing=100*c.bank.debt_financing,c.bank.loan_interest_rate=100*c.bank.loan_interest_rate,c.installation.degradation=100*c.installation.degradation,c.installation.opex=100*c.installation.opex,c.regulation.inflation=100*c.regulation.inflation,c.regulation.tax_rate=100*c.regulation.tax_rate},n=function(){for(var i=1;i<a;i++)o.energy_consumption_kwh[i]=c.regulation.energy_consumed},s=function(){for(var i=0,e=1;e<a;e++)i=Math.pow(o.inflation_rate_energy_cost,e-1),o.energy_consumption_eur[e]=o.energy_consumption_kwh[e]*c.regulation.tariff_consumer*i},t=function(){o.inflation_rate_energy_cost=1+c.regulation.inflation},l=function(){var a=c.installation.investment_bipv*c.bank.debt_financing,i=Math.pow(1+c.bank.loan_interest_rate,-c.bank.load_duration),e=c.bank.loan_interest_rate/(1-i);o.anual_repayment_interest=Math.round(a*e)},r=function(){var i=c.installation.tamano*c.installation.full_hours,e=0,n=1-c.installation.degradation;o.energy_generation_mwh[1]=i/1e3;for(var s=2;s<a;s++)e=Math.pow(n,s-1),o.energy_generation_mwh[s]=i*e/1e3},u=function(){for(var i=1;i<a;i++)o.gross_income[i]=Math.round(o.energy_generation_mwh[i]*c.regulation.tariff_producer*1e3)},d=function(){for(var i=c.installation.tamano*c.installation.opex*1e3,e=1;e<a;e++)o.o_m_cost[e]=Math.round(i*Math.pow(o.inflation_rate_energy_cost,e-1))},p=function(){o.balance[1]=c.bank.debt_financing*c.installation.investment_bipv,o.interests[1]=o.balance[1]*c.bank.loan_interest_rate,o.balance[1]-o.anual_repayment_interest>0&&(o.anual_repayment_interest_conditional[1]=o.anual_repayment_interest),o.repayment[1]=Math.abs(o.anual_repayment_interest_conditional[1]-o.interests[1]);for(var i=2;i<a;i++)o.balance[i]=o.balance[i-1]-o.repayment[i-1],o.interests[i]=Math.round(o.balance[i]*c.bank.loan_interest_rate),o.balance[i]-o.anual_repayment_interest>0?o.anual_repayment_interest_conditional[i]=o.anual_repayment_interest:0==o.balance[i]?o.anual_repayment_interest_conditional[i]=0:o.anual_repayment_interest_conditional[i]=Math.round(o.balance[i]+o.interests[i]),o.repayment[i]=Math.round(Math.abs(o.anual_repayment_interest_conditional[i]-o.interests[i]))},m=function(){for(var c=1;c<a;c++)o.production_consumptions_cost[c]=Math.round(o.gross_income[c]-o.energy_consumption_eur[c]-o.o_m_cost[c]-o.anual_repayment_interest_conditional[c])},f=function(){for(var c=1;c<a;c++)o.project_return[c]=Math.round(o.gross_income[c]-o.o_m_cost[c]-o.anual_repayment_interest_conditional[c])},g=function(){for(var i=1;i<a;i++)o.production_consumptions_cost[i]>0?o.taxes[i]=o.production_consumptions_cost[i]*c.regulation.tax_rate:o.taxes[i]=0},D=function(){o.investment=c.installation.investment_bipv*(1-c.bank.debt_financing),o.net_income_with_project[0]=-o.investment,o.net_income_wo_project[0]=-c.installation.investment_wo_bipv},C=function(){for(var c=1;c<a;c++)o.net_income_with_project[c]=Math.round(o.gross_income[c]-o.energy_consumption_eur[c]-o.o_m_cost[c]-o.anual_repayment_interest_conditional[c]-o.taxes[c]),o.net_income_wo_project[c]=-o.energy_consumption_eur[c]},H=function(){o.total_cash_flow_wo_project[0]=-c.installation.investment_wo_bipv,o.total_cash_flow_with_project[0]=-o.investment,o.total_cash_flow_with_project[1]=o.net_income_with_project[0]+o.net_income_with_project[1],o.total_cash_flow_wo_project[1]=o.net_income_wo_project[0]+o.net_income_wo_project[1];for(var i=2;i<a;i++)o.total_cash_flow_with_project[i]=Math.round(o.total_cash_flow_with_project[i-1]+o.net_income_with_project[i]),o.total_cash_flow_wo_project[i]=Math.round(o.total_cash_flow_wo_project[i-1]+o.net_income_wo_project[i])},I=function(){o.project_cashflow[0]=-c.installation.investment_bipv*(1-c.bank.debt_financing);for(var i=1;i<a;i++)o.project_cashflow[i]=o.gross_income[i]-o.o_m_cost[i]-o.anual_repayment_interest_conditional[i]},A=function(){o.cumulated_project_economy[0]=-c.installation.investment_bipv;for(var i=1;i<a;i++)o.cumulated_project_economy[i]=o.cumulated_project_economy[i-1]+o.project_cashflow[i]},P=function(){for(var c=1;c<a;c++)o.cumulated_project_economy[c]<0?o.test_payback_year[c]=0:o.cumulated_project_economy[c-1]>0?o.test_payback_year[c]=0:o.test_payback_year[c]=1},E=function(){for(var c=1;c<a;c++)o.consumption_negative[c]=Math.round(-o.energy_consumption_eur[c]),o.loan_interest[c]=Math.round(-o.anual_repayment_interest_conditional[c])},v=function(){for(var c=1;c<a;c++)o.electricity_bill_with_bipv[c]=Math.round(o.energy_consumption_eur[c]-o.gross_income[c]),o.electricity_bill_wo_bipv[c]=Math.round(o.energy_consumption_eur[c])},_=function(){o.investment=-o.investment;for(var c=1;c<a;c++)o.anual_repayment_interest_conditional[c]=-o.anual_repayment_interest_conditional[c],o.o_m_cost[c]=-o.o_m_cost[c]};return i(),l(),D(),t(),n(),s(),r(),u(),d(),p(),m(),f(),g(),C(),H(),I(),A(),P(),E(),v(),e(),_(),o}};return c}),app.factory("calculoImpactForTheElectricitySystemFactory",["$rootScope","calculosGenericosFactory",function(o,a){var c={calculos:{},init:function(){o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.peajesDeAccesoSinDH=o.datosTarifa.peajeAccesoEnergiaSinDh,"Sell to pool"==o.outputs.modelParams.remuneration.name||"Cession"==o.outputs.modelParams.remuneration.name?o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.reduccionElectricidadComprada=-o.objetoTabla.selfConsumedInstant:o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.reduccionElectricidadComprada=-o.objetoTabla.production,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.valor=parseFloat((o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.reduccionElectricidadComprada*o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.peajesDeAccesoSinDH/100).toFixed(1)),"Sell to pool"==o.outputs.modelParams.remuneration.name||"Cession"==o.outputs.modelParams.remuneration.name?(o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p1=-o.objetoTabla.selfConsumedInstantP1,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p2=-o.objetoTabla.selfConsumedInstantP2,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p3=-o.objetoTabla.selfConsumedInstantP3):(o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p1=-o.objetoTabla.productionP1,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p2=-o.objetoTabla.productionP2,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p3=-o.objetoTabla.productionP3),o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.peajesAccesoConDH.p1=o.datosTarifa.peajeAccesoEnergiaConDhP1,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.peajesAccesoConDH.p2=o.datosTarifa.peajeAccesoEnergiaConDhP2,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.peajesAccesoConDH.p3=o.datosTarifa.peajeAccesoEnergiaConDhP3,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.valor=Math.round((o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p1*o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.peajesAccesoConDH.p1+o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p2*o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.peajesAccesoConDH.p2+o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p3*o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.peajesAccesoConDH.p3)/100),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.valor=o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.valor:o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.valor=o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.valor,"Si"==o.calculos.inputs.regulacionDelAutoconsumo.pagosPorCapacidad?o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.sinDH.pagosPorCapacidadSinDH=0:o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.sinDH.pagosPorCapacidadSinDH=0,o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.sinDH.valor=o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.sinDH.pagosPorCapacidadSinDH*o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.reduccionElectricidadComprada/100,"Si"==o.calculos.inputs.regulacionDelAutoconsumo.pagosPorCapacidad?(o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p1=o.datosTarifa.pagosCapacidadConDhP1,o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p2=o.datosTarifa.pagosCapacidadConDhP2,o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p3=o.datosTarifa.pagosCapacidadConDhP3):(o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p1=0,o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p2=0,o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p3=0),o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.valor=(o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p1*o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p1+o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p2*o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p2+o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p3*o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.pagosPorCapacidadConDH.p3)/100,"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.valor=o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.sinDH.valor:o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.valor=o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.conDH.valor,"Si"==o.calculos.inputs.regulacionDelAutoconsumo.pagosPorCapacidad?o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.sinDH.sobrecosteServiciosAjuste=o.datosTarifa.sobrecoste:o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.sinDH.sobrecosteServiciosAjuste=0,o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.sinDH.valor=a.calculos.calculoProductoEntre100Fijo(o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.reduccionElectricidadComprada,o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.sinDH.sobrecosteServiciosAjuste),o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.conDH.valor=a.calculos.calculoProductoEntre100Fijo(o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.sinDH.sobrecosteServiciosAjuste,o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p1+o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p2+o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.conDH.electricidadAutoconsumidaDeFormaDiferida.p3),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.valor=o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.sinDH.valor:o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.valor=o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.conDH.valor,o.calculos.sistema_electrico.impactoPeajesBalanceNeto.sinDH.peajeBNSinDH=o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.sinDH.peajesDeAccesoSinDH*o.outputs.modelParams.excedentsToll/100,o.calculos.sistema_electrico.impactoPeajesBalanceNeto.sinDH.valor=a.calculos.calculoProductoEntre100Fijo(o.calculos.sistema_electrico.impactoPeajesBalanceNeto.sinDH.peajeBNSinDH,o.objetoTabla.selfConsumedDeferred),o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.peajesDeBNConDH.p1=o.datosTarifa.peajeAccesoEnergiaConDhP1*(o.outputs.modelParams.excedentsToll/100),o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.peajesDeBNConDH.p2=o.datosTarifa.peajeAccesoEnergiaConDhP2*(o.outputs.modelParams.excedentsToll/100),o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.peajesDeBNConDH.p3=o.datosTarifa.peajeAccesoEnergiaConDhP3*(o.outputs.modelParams.excedentsToll/100),o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.valor=(o.objetoTabla.selfConsumedDeferredP1*o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.peajesDeBNConDH.p1+o.objetoTabla.selfConsumedDeferredP2*o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.peajesDeBNConDH.p2+o.objetoTabla.selfConsumedDeferredP3*o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.peajesDeBNConDH.p3)/100,"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos.sistema_electrico.impactoPeajesBalanceNeto.valor=o.calculos.sistema_electrico.impactoPeajesBalanceNeto.sinDH.valor:o.calculos.sistema_electrico.impactoPeajesBalanceNeto.valor=o.calculos.sistema_electrico.impactoPeajesBalanceNeto.conDH.valor,o.calculos.hacienda_particular.IVAPeajeRespaldo.valorBasePeajeRespaldo=a.calculos.calculoDivisionProducto(o.calculos.usuario_particular.costePeajeRespaldoConImpuestos.valor),o.calculos.hacienda_particular.IVAPeajeRespaldo.valorBasePeajeRespaldo=o.calculos.hacienda_particular.IVAPeajeRespaldo.valorBasePeajeRespaldo.map(Math.round),o.calculos.sistema_electrico.impactoPorPeajeDeRespaldo=o.calculos.hacienda_particular.IVAPeajeRespaldo.valorBasePeajeRespaldo[0],"Sell to pool"==o.outputs.modelParams.remuneration.name?o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.energiaVertidaALaRed=o.objetoTabla.sold:o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.energiaVertidaALaRed=0,o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.valor=o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.peajeDeGeneracion*o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.energiaVertidaALaRed/100,"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos.sistema_electrico.ingresosEnergiaCedidaSistema.energiaCedida=o.objetoTabla.summaryLostGlobal:o.calculos.sistema_electrico.ingresosEnergiaCedidaSistema.energiaCedida=o.objetoTabla.summaryLostBalance,o.calculos.sistema_electrico.ingresosEnergiaCedidaSistema.valor=Math.round(o.calculos.sistema_electrico.ingresosEnergiaCedidaSistema.energiaCedida*o.calculos.sistema_electrico.ingresosEnergiaCedidaSistema.precioPool/1e3),o.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.impactoAnualSistemaElectricoEspanol=Math.round(o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.valor+o.calculos.sistema_electrico.impactoPorPagosPorCapacidad.valor+o.calculos.sistema_electrico.impactoSobrecostesServiciosAjuste.valor+o.calculos.sistema_electrico.impactoPeajesBalanceNeto.valor+o.calculos.sistema_electrico.impactoPorPeajeDeRespaldo+o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.valor+o.calculos.sistema_electrico.ingresosEnergiaCedidaSistema.valor),o.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.valor=Math.round(o.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.impactoAnualSistemaElectricoEspanol/o.objetoTabla.power*10)/10,o.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.variacionIngresosPorPeajes=Math.round(10*(o.calculos.sistema_electrico.impactoPorLosPeajesDeAcceso.valor+o.calculos.sistema_electrico.impactoPeajesBalanceNeto.valor+o.calculos.sistema_electrico.impactoPorPeajeDeRespaldo+o.calculos.sistema_electrico.ingresosPorPeajeDeGeneracion.valor))/10,o.calculos.sistema_electrico.ahorroEmisionCO2=Math.round(o.objetoTabla.production/1e3*o.calculos.inputs.informacionDeContorno.sistema_electrico.factorEmisionCO2*o.calculos.inputs.informacionDeContorno.sistema_electrico.precioToneladaCO2*10)/10}};return c}]),app.factory("calculoImpactForTheSelfConsumerFactory",["$rootScope","calculosGenericosFactory",function(o,a){function c(a,c,i){for(var e=[],n=0;n<o.annos;n++)e[n]=(a[n]+c[n])*i;return e}var i={config:{},init:function(){if(a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].sinDH.terminoDeEnergiaConImpuestos,o.datosTarifa.terminoEnergiaSinDh),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].conDH.p1.terminoDeEnergiaSinImpuestos,o.datosTarifa.terminoEnergiaConDhP1),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].conDH.p2.terminoDeEnergiaSinImpuestos,o.datosTarifa.terminoEnergiaConDhP2),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].conDH.p3.terminoDeEnergiaSinImpuestos,o.datosTarifa.terminoEnergiaConDhP3),a.calculos.calculoConProducto(o.calculos[o.config.tipoUsuario].alquiler_de_contador,10),o.calculos[o.config.tipoUsuario].alquiler_de_contador=o.calculos[o.config.tipoUsuario].alquiler_de_contador.map(Math.round),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaInstantaneamente,.006,o.objetoTabla.selfConsumedInstant),o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaInstantaneamente=o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaInstantaneamente.map(Math.round),a.calculos.calculoN33UsuarioParticular(),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaDeFormaDiferida,.006,o.objetoTabla.selfConsumedDeferred),o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaDeFormaDiferida=o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaDeFormaDiferida.map(Math.round),a.calculos.calculoResta(o.calculos[o.config.tipoUsuario].sinDH.electricidadConsumida,o.calculos[o.config.tipoUsuario].sinDH.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaDeFormaDiferida),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoUsuario].sinDH.valor,o.calculos[o.config.tipoUsuario].sinDH.electricidadConsumida,o.calculos[o.config.tipoUsuario].sinDH.terminoDeEnergiaConImpuestos),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaInstantaneamente,.006,o.objetoTabla.selfConsumedInstantP1),o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaInstantaneamente=o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaInstantaneamente.map(Math.round),a.calculos.calculoSumaResta(o.calculos[o.config.tipoUsuario].conDH.p1.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaInstantaneamente,o.objetoTabla.consumedNetP1),a.calculos.calculoProductoFijoEntre100(o.calculos[o.config.tipoUsuario].sinDH.costeElectricidadConsumida,o.objetoTabla.demand,o.calculos[o.config.tipoUsuario].sinDH.terminoDeEnergiaConImpuestos),o.calculos[o.config.tipoUsuario].sinDH.costeElectricidadConsumida=o.calculos[o.config.tipoUsuario].sinDH.costeElectricidadConsumida.map(Math.round),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaDeFormaDiferida,.006,o.objetoTabla.selfConsumedDeferredP1),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaInstantaneamente,.006,o.objetoTabla.selfConsumedInstantP2),o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaInstantaneamente=o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaInstantaneamente.map(Math.round),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaInstantaneamente,.006,o.objetoTabla.selfConsumedInstantP3),o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaInstantaneamente=o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaInstantaneamente.map(Math.round),a.calculos.calculoSumaResta(o.calculos[o.config.tipoUsuario].conDH.p2.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaInstantaneamente,o.objetoTabla.consumedNetP2),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaDeFormaDiferida,.006,o.objetoTabla.selfConsumedDeferredP2),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaDeFormaDiferida,.006,o.objetoTabla.selfConsumedDeferredP3),a.calculos.calculoResta(o.calculos[o.config.tipoUsuario].conDH.p2.electricidadConsumida,o.calculos[o.config.tipoUsuario].conDH.p2.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaDeFormaDiferida),a.calculos.calculoSumaProductos(o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumida,o.objetoTabla.demandP1,o.calculos[o.config.tipoUsuario].conDH.p1.terminoDeEnergiaSinImpuestos,o.objetoTabla.demandP2,o.calculos[o.config.tipoUsuario].conDH.p2.terminoDeEnergiaSinImpuestos,o.objetoTabla.demandP3,o.calculos[o.config.tipoUsuario].conDH.p3.terminoDeEnergiaSinImpuestos),o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumida=o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumida.map(Math.round),o.calculos.sistema_electrico.conDH.p3.peajesDeBNConDH=1+parseInt(o.outputs.modelParams.excedentsToll)/100*o.datosTarifa.peajeAccesoEnergiaConDhP3,o.calculos.sistema_electrico.conDH.p2.peajesDeBNConDH=1+parseInt(o.outputs.modelParams.excedentsToll)/100*o.datosTarifa.peajeAccesoEnergiaConDhP2,o.calculos.sistema_electrico.conDH.p1.peajesDeBNConDH=1+parseInt(o.outputs.modelParams.excedentsToll)/100*o.datosTarifa.peajeAccesoEnergiaConDhP1,a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].conDH.p1.cuotaBNConImpuestos,o.calculos.sistema_electrico.conDH.p1.peajesDeBNConDH),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].conDH.p2.cuotaBNConImpuestos,o.calculos.sistema_electrico.conDH.p2.peajesDeBNConDH),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].conDH.p3.cuotaBNConImpuestos,o.calculos.sistema_electrico.conDH.p3.peajesDeBNConDH),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoUsuario].costeElectricidadConsumidaSinFV=o.calculos[o.config.tipoUsuario].sinDH.costeElectricidadConsumida:o.calculos[o.config.tipoUsuario].costeElectricidadConsumidaSinFV=o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumida,a.calculos.calcularRestaInvertido(o.calculos[o.config.tipoUsuario].cashflowEscenarioSinFV,o.calculos[o.config.tipoUsuario].costeElectricidadConsumidaSinFV,o.calculos[o.config.tipoUsuario].alquiler_de_contador),"usuario_empresa"==o.config.tipoUsuario&&(o.calculos.usuario_empresa.reduccionImpuestoSociedadesSinFV=[],o.calculos.usuario_empresa.reduccionImpuestoSociedadesSinFV=a.calculos.calculoReduccionImpuestosSinFVEmpresa(o.calculos[o.config.tipoUsuario].costeElectricidadConsumidaSinFV,o.calculos[o.config.tipoUsuario].alquiler_de_contador,.25),o.calculos.usuario_empresa.reduccionImpuestoSociedades=[],o.calculos.usuario_empresa.reduccionImpuestoSociedades=this.calculos.reduccionImpuestoSociedades(o.calculos[o.config.tipoUsuario].costeElectricidadConsumidaSinFV,o.calculos[o.config.tipoUsuario].alquiler_de_contador,.25),a.calculos.calculoSuma(o.calculos[o.config.tipoUsuario].cashflowEscenarioSinFV,o.calculos[o.config.tipoUsuario].cashflowEscenarioSinFV,o.calculos.usuario_empresa.reduccionImpuestoSociedades)),a.calculos.calculoSumaResta(o.calculos[o.config.tipoUsuario].conDH.p3.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaInstantaneamente,o.objetoTabla.consumedNetP3),a.calculos.calculoResta(o.calculos[o.config.tipoUsuario].conDH.p3.electricidadConsumida,o.calculos[o.config.tipoUsuario].conDH.p3.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaDeFormaDiferida),a.calculos.calculoResta(o.calculos[o.config.tipoUsuario].conDH.p1.electricidadConsumida,o.calculos[o.config.tipoUsuario].conDH.p1.electricidadExtraidaDeLaRed,o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaDeFormaDiferida),a.calculos.calcularMultiplicacionSeisDatosEntre100(o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumidaSinFV,o.calculos[o.config.tipoUsuario].conDH.p1.electricidadConsumida,o.calculos[o.config.tipoUsuario].conDH.p1.terminoDeEnergiaSinImpuestos,o.calculos[o.config.tipoUsuario].conDH.p2.electricidadConsumida,o.calculos[o.config.tipoUsuario].conDH.p2.terminoDeEnergiaSinImpuestos,o.calculos[o.config.tipoUsuario].conDH.p3.electricidadConsumida,o.calculos[o.config.tipoUsuario].conDH.p3.terminoDeEnergiaSinImpuestos),o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumidaSinFV=o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumidaSinFV.map(Math.round),a.calculos.calculoConProducto(o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV,20),o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV=o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV.map(Math.round),a.calculos.calcularProductoIPC(o.calculos[o.config.tipoUsuario].costesDeSeguro,o.userType.costeDeSeguro*o.objetoTabla.power*1.15),o.calculos[o.config.tipoUsuario].costesDeSeguro=o.calculos[o.config.tipoUsuario].costesDeSeguro.map(Math.round),a.calculos.calcularConIVAEInversion(o.calculos[o.config.tipoUsuario].inversionInicial),o.calculos.inputs.gastosFinancieros.cantidadFinanciada=o.calculos.inputs.inversionInicial.inversionTotalConIVA*o.userType.apalancamiento,o.calculos.inputs.gastosFinancieros.costeDeuda=o.userType.costeDeuda,o.calculos.inputs.gastosFinancieros.duracion=o.userType.duracionDeuda,o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[0]=o.calculos.inputs.gastosFinancieros.cantidadFinanciada*o.calculos.inputs.gastosFinancieros.costeDeuda,a.calculos.calculoPagoInicial(),o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[0]=o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.pagoInicial[0]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[0],o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.saldo[0]=o.calculos.inputs.gastosFinancieros.cantidadFinanciada-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[0],a.calculos.calculoInteresesDelUsuarioParticular(),a.calculos.calculoCosteCambioInversorConIVA(),o.calculos.inputs.costesOM.incrementoCosteInversorIPCMaduracion=o.IPC-o.calculos.inputs.costesOM.disminucionDelCosteMaduracionTecnologica,a.calculos.calculoCosteCambioInversorConIVAActualizado(),a.calculos.calculoSumaProductosArray(o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConDH,o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoUsuario].conDH.p1.cuotaBNConImpuestos,o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoUsuario].conDH.p2.cuotaBNConImpuestos,o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoUsuario].conDH.p3.cuotaBNConImpuestos),o.calculos.sistema_electrico.sinDH.cuotaBN=o.datosTarifa.peajeAccesoEnergiaSinDh+1,a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].sinDH.cuotaBNConImpuestos,o.calculos.sistema_electrico.sinDH.cuotaBN),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoUsuario].sinDH.costeElectricidadFVAutoconsumidaDiferida,o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoUsuario].sinDH.cuotaBNConImpuestos),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoUsuario].costeElectricidadFVAutoconsumidaDiferida=o.calculos[o.config.tipoUsuario].sinDH.costeElectricidadFVAutoconsumidaDiferida:o.calculos[o.config.tipoUsuario].costeElectricidadFVAutoconsumidaDiferida=o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConDH,o.calculos.inputs.costesDeOM=0*o.objetoTabla.power*o.calculos.inputs.caracteristicasTecnicas.ratio,a.calculos.calculoConProducto(o.calculos[o.config.tipoUsuario].costesOM.costesOMConIVA,o.calculos.inputs.costesDeOM),a.calculos.calculoSuma(o.calculos[o.config.tipoUsuario].costeDeOM,o.calculos[o.config.tipoUsuario].costesOM.costesOMConIVA,o.calculos.inputs.costesOM.costeCambioInversorConIVAActualizado),"0"==o.outputs.modelParams.backupToll.value?o.calculos.inputs.costePeajeRespaldoConImpuestos.sinDH.terminoDeEnergiaSinImpuestos=0:o.calculos.inputs.costePeajeRespaldoConImpuestos.sinDH.terminoDeEnergiaSinImpuestos=o.datosTarifa.peajeRespaldoSinDh,a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.sinDH.terminoDeEnergiaConImpuestos,o.calculos.inputs.costePeajeRespaldoConImpuestos.sinDH.terminoDeEnergiaSinImpuestos),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.sinDH.electricidadAutoconsumidaInstantaneamente,o.calculos.inputs.caracteristicasTecnicas.perdidaRendimientoAnual,o.objetoTabla.selfConsumedInstant),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.sinDH.costePeaje,o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.sinDH.electricidadAutoconsumidaInstantaneamente,o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.sinDH.terminoDeEnergiaConImpuestos),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p1.consumo,o.calculos.inputs.caracteristicasTecnicas.perdidaRendimientoAnual,o.objetoTabla.selfConsumedInstantP1),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p2.consumo,o.calculos.inputs.caracteristicasTecnicas.perdidaRendimientoAnual,o.objetoTabla.selfConsumedInstantP2),a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].conDH.p3.consumo,o.calculos.inputs.caracteristicasTecnicas.perdidaRendimientoAnual,o.objetoTabla.selfConsumedInstantP3),"0"==o.outputs.modelParams.backupToll.value?(o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p1=0,
o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p2=0,o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p3=0):(o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p1=o.datosTarifa.peajeRespaldoConDhP1,o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p2=o.datosTarifa.peajeRespaldoConDhP2,o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p3=o.datosTarifa.peajeRespaldoConDhP3),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p1,o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p1),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p2,o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p2),a.calculos.calculoConProductoEIncremento(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p3,o.calculos.inputs.costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p3),a.calculos.calcularMultiplicacionSeisDatosEntre100(o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.costePeajeRespaldoConImpuestos,o.calculos[o.config.tipoUsuario].conDH.p1.consumo,o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p1,o.calculos[o.config.tipoUsuario].conDH.p2.consumo,o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p2,o.calculos[o.config.tipoUsuario].conDH.p3.consumo,o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.terminoDeEnergiaDHConImpuestos.p3),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.valor=o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.sinDH.costePeaje:o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.valor=o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.conDH.costePeajeRespaldoConImpuestos,"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoUsuario].costeElectricidadConsumida.valor=o.calculos[o.config.tipoUsuario].sinDH.valor:o.calculos[o.config.tipoUsuario].costeElectricidadConsumida.valor=o.calculos[o.config.tipoUsuario].conDH.costeElectricidadConsumidaSinFV,"usuario_empresa"==o.config.tipoUsuario&&(o.calculos.usuario_empresa.electricidadInyectadaALaRed=[],"3"==o.outputs.modelParams.remuneration.value?a.calculos.calculoConAsignacionDirecta(o.calculos.usuario_empresa.electricidadInyectadaALaRed,.006,o.objetoTabla.sold):a.calculos.calculoConAsignacionDirecta(o.calculos.usuario_empresa.electricidadInyectadaALaRed,.006,0),o.calculos.usuario_empresa.precioVentaPool=[],o.calculos.usuario_empresa.precioVentaPool=a.calculos.calculoAsignacionProductoDatoFijo(1.02,4.5),o.calculos.usuario_empresa.ventasAlPool=[],a.calculos.calculoProductoEntre100(o.calculos.usuario_empresa.ventasAlPool,o.calculos.usuario_empresa.electricidadInyectadaALaRed,o.calculos.usuario_empresa.precioVentaPool),o.calculos.usuario_empresa.peajeDeGeneracion=[],a.calculos.calculoConProductoEIncrementoSoloCrecimiento(o.calculos.usuario_empresa.peajeDeGeneracion,.05),o.calculos.usuario_empresa.peajeDeGeneracion=o.calculos.usuario_empresa.peajeDeGeneracion.map(Math.round),o.calculos.usuario_empresa.costeDeGestion=[],a.calculos.calculoConProductoEIncrementoSoloCrecimiento(o.calculos.usuario_empresa.costeDeGestion,.001),o.calculos.usuario_empresa.costesPorVentaAlPool=[],a.calculos.calcularSumaMultiplicacionDosArrays(o.calculos.usuario_empresa.costesPorVentaAlPool,o.calculos.usuario_empresa.peajeDeGeneracion,o.calculos.usuario_empresa.costeDeGestion,o.calculos.usuario_empresa.electricidadInyectadaALaRed),o.calculos.usuario_empresa.soloOpcionVentaPool=[],a.calculos.calculoResta(o.calculos.usuario_empresa.soloOpcionVentaPool,o.calculos.usuario_empresa.ventasAlPool,o.calculos.usuario_empresa.costesPorVentaAlPool),o.calculos.usuario_empresa.costePeajeRespaldo={valor:[],sinDH:{valor:[],electricidadAutoconsumidaInstantaneamente:[],terminoDeEnergiaConImpuestosSinIVA:[]},conDH:{valor:[],consumo:{p1:[],p2:[],p3:[]},terminoDeEnergiaDHConImpuestosSinIVA:{p1:[],p2:[],p3:[]}}},a.calculos.calculoConAsignacionDirecta(o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.electricidadAutoconsumidaInstantaneamente,.006,o.objetoTabla.selfConsumedInstant),"1"==o.outputs.modelParams.backupToll.value?a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.terminoDeEnergiaConImpuestosSinIVA,o.datosTarifa.peajeRespaldoSinDh):a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.terminoDeEnergiaConImpuestosSinIVA,0),a.calculos.calculoProductoEntre100(o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.valor,o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.terminoDeEnergiaConImpuestosSinIVA,o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.electricidadAutoconsumidaInstantaneamente),a.calculos.calculoConAsignacionDirecta(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.consumo.p1,.006,o.objetoTabla.selfConsumedInstantP1),a.calculos.calculoConAsignacionDirecta(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.consumo.p2,.006,o.objetoTabla.selfConsumedInstantP2),a.calculos.calculoConAsignacionDirecta(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.consumo.p3,.006,o.objetoTabla.selfConsumedInstantP3),"1"==o.outputs.modelParams.backupToll.value?(a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p1,o.datosTarifa.peajeRespaldoConDhP1),a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p2,o.datosTarifa.peajeRespaldoConDhP2),a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p3,o.datosTarifa.peajeRespaldoConDhP3)):(a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p1,0),a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p2,0),a.calculos.calculoConProductoEIncremento(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p3,0)),a.calculos.calcularMultiplicacionSeisDatosEntre100(o.calculos.usuario_empresa.costePeajeRespaldo.conDH.valor,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.consumo.p1,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p1,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.consumo.p2,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p2,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.consumo.p3,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.terminoDeEnergiaDHConImpuestosSinIVA.p3),o.calculos.usuario_empresa.costePeajeRespaldo.valor=a.calculos.devolverWithoutHD(o.calculos.usuario_empresa.costePeajeRespaldo.sinDH.valor,o.calculos.usuario_empresa.costePeajeRespaldo.conDH.valor)),a.calculos.calculoCashflowEscenarioConFV(),a.calculos.calculoResta(o.calculos[o.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV,o.calculos[o.config.tipoUsuario].cashflowEscenarioConFV,o.calculos[o.config.tipoUsuario].cashflowEscenarioSinFV),o.calculos[o.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV=o.calculos[o.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV.map(Math.round),a.calculos.calculoSumaArrayConDato(o.calculos[o.config.tipoUsuario].indicadores.cashflowAcumulado,o.calculos[o.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV),o.calculos[o.config.tipoUsuario].indicadores.cashflowAcumulado=o.calculos[o.config.tipoUsuario].indicadores.cashflowAcumulado.map(Math.round),"usuario_empresa"==o.config.tipoUsuario)for(var c=0;c<o.annos;c++)o.calculos[o.config.tipoUsuario].precioMedioElectricidadComprada[c]=100*(o.calculos[o.config.tipoUsuario].costeElectricidadConsumidaSinFV[c]+o.calculos[o.config.tipoUsuario].alquiler_de_contador[c])/o.objetoTabla.demand;else a.calculos.calcularProductoArrayEntre100(o.calculos[o.config.tipoUsuario].precioMedioElectricidadComprada,o.calculos[o.config.tipoUsuario].cashflowEscenarioSinFV,o.objetoTabla.demand);a.calculos.calculoConAsignacionDirecta(o.calculos[o.config.tipoUsuario].energiaProducida,.006,o.objetoTabla.production),o.calculos[o.config.tipoUsuario].energiaProducida=o.calculos[o.config.tipoUsuario].energiaProducida.map(Math.round),o.calculos[o.config.tipoUsuario].VANEnergiaProducida=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].energiaProducida,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].VANCostesOM=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].costeDeOM,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].VANAlquilerContador=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].VANCostesSeguro=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].costesDeSeguro,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].VANInversionInicial=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].inversionInicial,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].VANGastosFinancieros=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].VANPagoPrincipal=a.calculos.calcularVAN(o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion,o.userType.tasaDescuentoUsuario),o.calculos[o.config.tipoUsuario].LCOE=(o.calculos[o.config.tipoUsuario].VANPagoPrincipal+o.calculos[o.config.tipoUsuario].VANGastosFinancieros+o.calculos[o.config.tipoUsuario].VANInversionInicial+o.calculos[o.config.tipoUsuario].VANCostesSeguro+o.calculos[o.config.tipoUsuario].VANAlquilerContador+o.calculos[o.config.tipoUsuario].VANCostesOM)/(100*o.calculos[o.config.tipoUsuario].VANEnergiaProducida)*1e4,o.calculos[o.config.tipoUsuario].LCOE=Math.round(10*o.calculos[o.config.tipoUsuario].LCOE)/10},calculos:{calcularTIR:a.calculos.calcularTIR,calcularVAN:a.calculos.calcularVAN,calcularPorcentajeDeEnergia:a.calculos.calcularPorcentajeDeEnergia,reduccionImpuestoSociedades:c}};return i}]),app.factory("calculoImpactOnPublicFinancesFactory",["$rootScope","calculosGenericosFactory",function(o,a){var c={calculos:{calculoCashflowAcumulado:function(){var a=[];a[0]=o.calculos[o.config.tipoHacienda].diferenciaRecaudacion.valor[0];for(var c=1;c<o.annos;c++)a[c]=a[c-1]+o.calculos[o.config.tipoHacienda].diferenciaRecaudacion.valor[c];return a},calculoRecaudacionEscenarioConFV:function(){var a=[];a[0]=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.valor[0]+o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.valor[0]+o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.valor[0]+o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.valor[0]+o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valor[0]+o.calculos[o.config.tipoHacienda].IVACostesOM.valor[0]+o.calculos[o.config.tipoHacienda].IVAAlquilerContador.valor[0]+o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor[0]+o.calculos[o.config.tipoHacienda].IVAInversion.valor-o.calculos[o.config.tipoHacienda].ayudasPublicasALaInversion.valor+o.calculos[o.config.tipoHacienda].incrementoImpuestoSociedadesInstalador.valor;for(var c=1;c<o.annos;c++)a[c]=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.valor[c]+o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.valor[c]+o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.valor[c]+o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.valor[c]+o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valor[c]+o.calculos[o.config.tipoHacienda].IVACostesOM.valor[c]+o.calculos[o.config.tipoHacienda].IVAAlquilerContador.valor[c]+o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor[c];return a},calculoRecaudacionEscenarioConFVEmpresa:function(){var a=[];a[0]=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.valor[0]+o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.valor[0]+o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor[0]-o.calculos.usuario_empresa.reduccionImpuestoSociedades[0]-o.calculos[o.config.tipoHacienda].ayudasPublicasALaInversion.valor+o.calculos[o.config.tipoHacienda].incrementoImpuestoSociedadesInstalador.valor;for(var c=1;c<o.annos;c++)a[c]=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.valor[c]+o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.valor[c]+o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor[c]-o.calculos.usuario_empresa.reduccionImpuestoSociedades[c];return a},calculoSumaDeTres:function(a,c,i){for(var e=[],n=0;n<o.annos;n++)e[n]=a[n]+c[n]+i[n];return e}},init:function(){o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p1=o.calculos[o.config.tipoUsuario].conDH.p1.electricidadConsumida,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p2=o.calculos[o.config.tipoUsuario].conDH.p2.electricidadConsumida,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p3=o.calculos[o.config.tipoUsuario].conDH.p3.electricidadConsumida,a.calculos.calculoConProductoEIncrementoSoloIVA(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p1,o.datosTarifa.terminoEnergiaConDhP1),a.calculos.calculoConProductoEIncrementoSoloIVA(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p2,o.datosTarifa.terminoEnergiaConDhP2),a.calculos.calculoConProductoEIncrementoSoloIVA(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p3,o.datosTarifa.terminoEnergiaConDhP3),a.calculos.calculoSumaProductosArray(o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p1,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p1,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p2,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p2,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p3,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p3),o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.valor=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.valor.map(Math.round),o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.electricidadConsumida=o.calculos[o.config.tipoUsuario].sinDH.electricidadConsumida,"usuario_empresa"==o.config.tipoUsuario?a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.terminoDeEnergiaSinDH,o.datosTarifa.terminoEnergiaSinDh):a.calculos.calculoConProductoEIncrementoSoloIVA(o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.terminoDeEnergiaSinDH,o.datosTarifa.terminoEnergiaSinDh),o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.terminoDeEnergiaSinDH=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.terminoDeEnergiaSinDH.map(function(o){return Math.round(100*o)/100}),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.electricidadConsumida,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.terminoDeEnergiaSinDH),o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.valor=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.valor.map(Math.round),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.valor=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.valor:o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.valor=o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.valor,a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p1,o.datosTarifa.terminoEnergiaConDhP1),a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p2,o.datosTarifa.terminoEnergiaConDhP2),a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p3,o.datosTarifa.terminoEnergiaConDhP3),a.calculos.calculoSumaProductosArray(o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p1,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p1,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p2,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p2,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.conDH.electricidadConsumida.p3,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p3),o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.valor=o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.valor.map(Math.round),a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.terminoDeEnergiaSinDH,o.datosTarifa.terminoEnergiaSinDh),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.valor,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.terminoDeEnergiaSinDH,o.calculos[o.config.tipoHacienda].IVAElectricidadConsumida.sinDH.electricidadConsumida),o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.valor=o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.valor.map(Math.round),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.valor=o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.valor:o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.valor=o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.electricidadAutoconsumidaDeFormaDiferida=o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaDeFormaDiferida,"usuario_empresa"==o.config.tipoUsuario?a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.IVASinCuotaBN,o.calculos.sistema_electrico.sinDH.cuotaBN):a.calculos.calculoConProductoEIncrementoSoloIVA(o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.IVASinCuotaBN,o.calculos.sistema_electrico.sinDH.cuotaBN),o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.IVASinCuotaBN=o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.IVASinCuotaBN.map(function(o){return Math.round(100*o)/100}),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.IVASinCuotaBN,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.electricidadAutoconsumidaDeFormaDiferida),o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p1.electricidadAutoconsumidaDeFormaDiferida=o.calculos[o.config.tipoUsuario].conDH.p1.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p2.electricidadAutoconsumidaDeFormaDiferida=o.calculos[o.config.tipoUsuario].conDH.p2.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p3.electricidadAutoconsumidaDeFormaDiferida=o.calculos[o.config.tipoUsuario].conDH.p3.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p1.cuotaBN=o.calculos.sistema_electrico.conDH.p1.peajesDeBNConDH,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p2.cuotaBN=o.calculos.sistema_electrico.conDH.p2.peajesDeBNConDH,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p3.cuotaBN=o.calculos.sistema_electrico.conDH.p3.peajesDeBNConDH,a.calculos.calculoSumaProductos(o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p1.cuotaBN,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p1.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p2.cuotaBN,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p2.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p3.cuotaBN,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p3.electricidadAutoconsumidaDeFormaDiferida),"1"==o.outputs.generalChar.timeDiscrimination.value?o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.valor=o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.valor:o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.valor=o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.valor,a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.sinDH.cuotaBN,o.calculos.sistema_electrico.sinDH.cuotaBN),a.calculos.calculoProductoEntre100(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.sinDH.valor,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.sinDH.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.sinDH.cuotaBN),a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p1,o.calculos.sistema_electrico.conDH.p1.peajesDeBNConDH),o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p1=o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p1.map(function(o){return Math.round(100*o)/100}),a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p2,o.calculos.sistema_electrico.conDH.p2.peajesDeBNConDH),o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p2=o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p2.map(function(o){return Math.round(100*o)/100}),a.calculos.calculoConProductoEIncrementoSoloIE(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p3,o.calculos.sistema_electrico.conDH.p3.peajesDeBNConDH),o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p3=o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p3.map(function(o){return Math.round(100*o)/100}),a.calculos.calculoSumaProductosArray(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.valor,o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p1,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p1.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p2,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p2.electricidadAutoconsumidaDeFormaDiferida,o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.p3,o.calculos[o.config.tipoHacienda].IVAElectricidadAutoconsumidaDiferida.conDH.p3.electricidadAutoconsumidaDeFormaDiferida),o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.valor=a.calculos.devolverWithoutHD(o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.sinDH.valor,o.calculos[o.config.tipoHacienda].IEElectricidadConsumidaFormaDiferida.conDH.valor),a.calculos.calculoArrayEntreProducto(o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valorBasePeajeRespaldo,o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.valor),a.calculos.calculoArrayDatoFijo(o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valor,o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valorBasePeajeRespaldo,o.IVA),o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valor=o.calculos[o.config.tipoHacienda].IVAPeajeRespaldo.valor.map(Math.round),a.calculos.calcularProductoIPC(o.calculos[o.config.tipoHacienda].IVACostesOM.IVACostesOM.valor,o.calculos.inputs.costesDeOM*o.IVA),o.calculos[o.config.tipoHacienda].IVACostesOM.IVACosteCambioInversorActualizado.IVACosteCambioInversor=.3*o.objetoTabla.power*1e3*o.IVA,a.calculos.calculoCosteCambioInversorConIVAActualizadoParametros(o.calculos[o.config.tipoHacienda].IVACostesOM.IVACosteCambioInversorActualizado.valor,o.calculos.inputs.costesOM.incrementoCosteInversorIPCMaduracion),a.calculos.calculoSuma(o.calculos[o.config.tipoHacienda].IVACostesOM.valor,o.calculos[o.config.tipoHacienda].IVACostesOM.IVACosteCambioInversorActualizado.valor,o.calculos[o.config.tipoHacienda].IVACostesOM.IVACostesOM.valor),a.calculos.calcularProductoIPC(o.calculos[o.config.tipoHacienda].IVAAlquilerContador.valor,o.calculos.inputs.alquilerDeContadores.conFV*o.IVA),o.calculos[o.config.tipoHacienda].IVAAlquilerContador.valor=o.calculos[o.config.tipoHacienda].IVAAlquilerContador.valor.map(Math.round),o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.costeSeguro=o.calculos[o.config.tipoUsuario].costesDeSeguro,a.calculos.calculoArrayDatoFijo(o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor,o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.costeSeguro,.04),o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor=o.calculos[o.config.tipoHacienda].impuestoPrimasSeguros.valor.map(Math.round),o.calculos[o.config.tipoHacienda].IVAInversion.inversionSinIVA=o.objetoTabla.power*o.outputs.generalChar.epc*1.15*1e3,o.calculos[o.config.tipoHacienda].IVAInversion.valor=o.calculos[o.config.tipoHacienda].IVAInversion.inversionSinIVA*o.IVA,o.calculos[o.config.tipoHacienda].ayudasPublicasALaInversion.porcentajeDeAyudasPublicas=parseInt(o.outputs.modelParams.investmentAids),o.calculos[o.config.tipoHacienda].ayudasPublicasALaInversion.valor=o.calculos[o.config.tipoHacienda].IVAInversion.inversionSinIVA*(o.calculos[o.config.tipoHacienda].ayudasPublicasALaInversion.porcentajeDeAyudasPublicas/100),o.calculos[o.config.tipoHacienda].incrementoImpuestoSociedadesInstalador.valor=.15*o.calculos[o.config.tipoHacienda].IVAInversion.inversionSinIVA*.25,"usuario_particular"==o.config.tipoUsuario?o.calculos[o.config.tipoHacienda].recaudacionEscenarioConFV.valor=this.calculos.calculoRecaudacionEscenarioConFV():o.calculos[o.config.tipoHacienda].recaudacionEscenarioConFV.valor=this.calculos.calculoRecaudacionEscenarioConFVEmpresa(),"usuario_empresa"==o.config.tipoUsuario?a.calculos.calcularProductoIPC(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.IVATerminoEnergiaSinDH,o.datosTarifa.terminoEnergiaSinDh*o.IE):a.calculos.calcularProductoIPC(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.IVATerminoEnergiaSinDH,o.datosTarifa.terminoEnergiaSinDh*o.IVA),a.calculos.calculoProductoFijoEntre100(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.valor,o.objetoTabla.demand,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.IVATerminoEnergiaSinDH),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.valor=o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.valor.map(Math.round),a.calculos.calculoSumaProductos(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor,o.objetoTabla.demandP1,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p1,o.objetoTabla.demandP2,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p2,o.objetoTabla.demandP3,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.IVATerminoEnergiaConDH.p3),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor=o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor.map(Math.round),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IVAElectricidadConsumida.valor=a.calculos.devolverWithoutHD(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.sinDH.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor),a.calculos.calculoProductoFijoEntre100(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.sinDH.valor,o.objetoTabla.demand,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.sinDH.terminoDeEnergiaSinDH),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.sinDH.valor=o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.sinDH.valor.map(Math.round),a.calculos.calculoSumaProductos(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor,o.objetoTabla.demandP1,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p1,o.objetoTabla.demandP2,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p2,o.objetoTabla.demandP3,o.calculos[o.config.tipoHacienda].IEElectricidadConsumida.conDH.p3),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor=o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor.map(Math.round),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.valor=a.calculos.devolverWithoutHD(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.sinDH.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.conDH.valor),a.calculos.calcularProductoIPC(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IVAAlquilerContador.valor,10*o.IVA),o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IVAAlquilerContador.valor=o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IVAAlquilerContador.valor.map(Math.round),"usuario_particular"==o.config.tipoUsuario?o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.valor=this.calculos.calculoSumaDeTres(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IVAAlquilerContador.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IVAElectricidadConsumida.valor):a.calculos.calculoResta(o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.IEElectricidadConsumida.valor,o.calculos.usuario_empresa.reduccionImpuestoSociedadesSinFV),a.calculos.calculoResta(o.calculos[o.config.tipoHacienda].diferenciaRecaudacion.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioConFV.valor,o.calculos[o.config.tipoHacienda].recaudacionEscenarioSinFV.valor),o.calculos[o.config.tipoHacienda].indicadores.VAN=a.calculos.calcularVAN(o.calculos[o.config.tipoHacienda].diferenciaRecaudacion.valor,.02),o.calculos[o.config.tipoHacienda].indicadores.VANPorMWn=o.calculos[o.config.tipoHacienda].indicadores.VAN/o.objetoTabla.power,
o.calculos[o.config.tipoHacienda].indicadores.VANPorMWn=Math.round(o.calculos[o.config.tipoHacienda].indicadores.VANPorMWn),o.calculos[o.config.tipoHacienda].indicadores.VANPorKWPVGenerado=100*o.calculos[o.config.tipoHacienda].indicadores.VAN/o.calculos[o.config.tipoUsuario].VANEnergiaProducida,o.calculos[o.config.tipoHacienda].indicadores.VANPorKWPVGenerado=Math.round(10*o.calculos[o.config.tipoHacienda].indicadores.VANPorKWPVGenerado)/10,o.calculos[o.config.tipoHacienda].cashflowAcumulado=this.calculos.calculoCashflowAcumulado(),o.calculos[o.config.tipoHacienda].cashflowAcumulado=o.calculos[o.config.tipoHacienda].cashflowAcumulado.map(Math.round)}};return c}]),app.factory("calculosGenericosFactory",["$rootScope",function(o){function a(a,c){var i=[];i[0]=c;for(var e=1;e<o.annos;e++)i[e]=i[e-1]*a;return i}function c(a,c,i){for(var e=[],n=0;n<o.annos;n++)e[n]=(a[n]+c[n])*i;return e}function i(a,c){return"1"==o.outputs.generalChar.timeDiscrimination.value?a:c}function e(a,c,i){for(var e=0;e<o.annos;e++)a[e]=c[e]*i}function n(a,c){for(var i=(1+o.IVA)*(1+o.IE),e=0;e<o.annos;e++)a[e]=c[e]/i}function s(){"usuario_particular"==o.config.tipoUsuario?o.calculos.inputs.costesOM.costeCambioInversorConIVA=o.objetoTabla.power*o.calculos.inputs.costesOM.costeCambioInversor*1e3*(1+o.IVA):o.calculos.inputs.costesOM.costeCambioInversorConIVA=o.objetoTabla.power*o.calculos.inputs.costesOM.costeCambioInversor*1e3}function t(){o.calculos.inputs.costesOM.costeCambioInversorConIVAActualizado[0]=0;for(var a=1;a<o.annos;a++)(a+1)%o.calculos.inputs.caracteristicasTecnicas.vidaUtilInversor==0?o.calculos.inputs.costesOM.costeCambioInversorConIVAActualizado[a]=o.calculos.inputs.costesOM.costeCambioInversorConIVA:o.calculos.inputs.costesOM.costeCambioInversorConIVAActualizado[a]=0}function l(a,c){a[0]=0;for(var i=1;i<o.annos;i++)(i+1)%o.calculos.inputs.caracteristicasTecnicas.vidaUtilInversor==0?a[i]=o.calculos.hacienda_particular.IVACostesOM.IVACosteCambioInversorActualizado.IVACosteCambioInversor*Math.pow(1+c,i-1):a[i]=0}function r(a,c,i){for(var e=0;e<o.annos;e++)a[e]=-Math.round(100*c[e]/i*10)/10}function u(){if("usuario_particular"==o.config.tipoUsuario)for(var a=0;a<o.annos;a++)o.calculos[o.config.tipoUsuario].cashflowEscenarioConFV[a]=-o.calculos[o.config.tipoUsuario].costeElectricidadConsumida.valor[a]-o.calculos[o.config.tipoUsuario].costeElectricidadFVAutoconsumidaDiferida[a]-o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.valor[a]-o.calculos[o.config.tipoUsuario].costeDeOM[a]-o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV[a]-o.calculos[o.config.tipoUsuario].costesDeSeguro[a]-o.calculos[o.config.tipoUsuario].inversionInicial[a]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[a]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[a];else{o.calculos.usuario_empresa.reduccionImpuestoSociedades=[];for(var c=[],a=0;a<o.annos;a++)c[a]=a<10?o.calculos.inputs.inversionInicial.inversionTotalConIVA/10:0;for(var a=0;a<o.annos;a++)o.calculos.usuario_empresa.reduccionImpuestoSociedades[a]=.25*parseInt(o.calculos[o.config.tipoUsuario].costeElectricidadConsumida.valor[a]+o.calculos[o.config.tipoUsuario].costeElectricidadFVAutoconsumidaDiferida[a]+o.calculos[o.config.tipoUsuario].costeDeOM[a]+o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV[a]+o.calculos[o.config.tipoUsuario].costesDeSeguro[a]+o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[a]+c[a]);for(var a=0;a<o.annos;a++)o.calculos[o.config.tipoUsuario].cashflowEscenarioConFV[a]=-o.calculos[o.config.tipoUsuario].costeElectricidadConsumida.valor[a]-o.calculos[o.config.tipoUsuario].costeElectricidadFVAutoconsumidaDiferida[a]+o.calculos.usuario_empresa.soloOpcionVentaPool[a]-o.calculos[o.config.tipoUsuario].costePeajeRespaldoConImpuestos.valor[a]-o.calculos[o.config.tipoUsuario].costeDeOM[a]-o.calculos[o.config.tipoUsuario].alquiler_de_contadorConFV[a]-o.calculos[o.config.tipoUsuario].costesDeSeguro[a]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[a]+o.calculos.usuario_empresa.reduccionImpuestoSociedades[a]-o.calculos[o.config.tipoUsuario].inversionInicial[a]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[a]}}function d(){for(var a=1;a<o.annos;a++)a<o.calculos.inputs.gastosFinancieros.duracion?(o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[a]=o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.saldo[a-1]*o.calculos.inputs.gastosFinancieros.costeDeuda,o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[a]=o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.pagoInicial[a-1]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[a]):(o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.intereses[a]=0,o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[a]=0),o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.saldo[a]=o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.saldo[a-1]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[a]<0?0:o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.saldo[a-1]-o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.amortizacion[a]}function p(){for(var a=1-Math.pow(1+o.calculos.inputs.gastosFinancieros.costeDeuda,-o.calculos.inputs.gastosFinancieros.duracion),c=o.calculos.inputs.gastosFinancieros.cantidadFinanciada*o.calculos.inputs.gastosFinancieros.costeDeuda/a,i=0;i<o.annos;i++)o.calculos.inputs.gastosFinancieros.duracion>i?o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.pagoInicial[i]=c:o.calculos[o.config.tipoUsuario].calculoGastosFinancieros.pagoInicial[i]=0}function m(a){"usuario_particular"==o.config.tipoUsuario?o.calculos.inputs.inversionInicial.inversionTotalConIVA=1.15*o.objetoTabla.power*o.userType.llaveEnMano*(1+o.IVA-parseInt(o.outputs.modelParams.investmentAids)/100)*1e3:o.calculos.inputs.inversionInicial.inversionTotalConIVA=1.15*o.objetoTabla.power*o.userType.llaveEnMano*(1-parseInt(o.outputs.modelParams.investmentAids)/100)*1e3,a[0]=o.calculos.inputs.inversionInicial.inversionTotalConIVA*(1-o.userType.apalancamiento);for(var c=1;c<o.annos;c++)a[c]=0}function f(a,c){var i=1+o.IPC;a[0]=c;for(var e=1;e<o.annos;e++)a[e]=a[e-1]*i}function g(a,c,i,e){for(var n=0;n<o.annos;n++)a[n]=e[n]*(c[n]+i[n])/100}function D(a,c,i,e,n,s,t){for(var l=0;l<o.annos;l++)a[l]=(c[l]*i[l]+e[l]*n[l]+s[l]*t[l])/100}function C(o,a,c,i,e,n,s){o=(a*c+i*e+n*s)/100}function H(a,c,i){for(var e=0;e<o.annos;e++)a[e]=-parseInt(c[e])-parseInt(i[e])}function I(a,c,i){a="1"==o.outputs.generalChar.timeDiscrimination.value?c:i}function A(a,c,i,e,n,s,t){for(var l=0;l<o.annos;l++)a[l]=(c[l]*i[l]+e[l]*n[l]+s[l]*t[l])/100}function P(a,c,i,e,n,s,t){for(var l=0;l<o.annos;l++)a[l]=(c*i[l]+e*n[l]+s*t[l])/100}function E(a,c,i){for(var e=0;e<o.annos;e++)a[e]=c*i[e]/100}function v(a,c,i){for(var e=0;e<o.annos;e++)a[e]=c[e]*i[e]/100}function _(o,a){return o*a/100}function h(a,c,i){for(var e=0;e<o.annos;e++)a[e]=c[e]+i[e]}function V(a,c,i){for(var e=0;e<o.annos;e++)a[e]=c[e]-i[e]}function j(a,c,i){a[0]=i;for(var e=1;e<o.annos;e++)a[e]=a[e-1]+c[e-1]-c[e]}function F(a,c){a[0]=c[0];for(var i=1;i<o.annos;i++)a[i]=a[i-1]+c[i]}function S(){o.calculos[o.config.tipoUsuario].sinDH.electricidadExtraidaDeLaRed[0]=o.objetoTabla.consumedNet;for(var a=1;a<o.annos;a++)o.calculos[o.config.tipoUsuario].sinDH.electricidadExtraidaDeLaRed[a]=o.calculos[o.config.tipoUsuario].sinDH.electricidadExtraidaDeLaRed[a-1]+o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaInstantaneamente[a-1]-o.calculos[o.config.tipoUsuario].sinDH.electricidadAutoconsumidaInstantaneamente[a]}function b(a,c,i){var e=1-c;a[0]=i;for(var n=1;n<o.annos;n++)a[n]=a[n-1]*e}function y(a,c){var i=1+o.IPC;a[0]="usuario_empresa"==o.config.tipoUsuario?c:c*(1+o.IVA);for(var e=1;e<o.annos;e++)a[e]=a[e-1]*i}function U(a){for(var c=[],i=0;i<o.annos;i++)c[i]=a[i]/o.producto;return c}function T(a,c){var i=1+parseFloat(o.outputs.generalChar.annualRate)/100;a[0]=c*o.producto;for(var e=1;e<o.annos;e++)a[e]=a[e-1]*i}function w(a,c){var i=1+parseFloat(o.outputs.generalChar.annualRate)/100;a[0]=c*o.IVA;for(var e=1;e<o.annos;e++)a[e]=a[e-1]*i}function M(a,c){var i=1+parseFloat(o.outputs.generalChar.annualRate)/100;a[0]=Math.round(c*o.IE*100)/100;for(var e=1;e<o.annos;e++)a[e]=a[e-1]*i}function R(a,c){var i=1+parseFloat(o.outputs.generalChar.annualRate)/100;a[0]=c;for(var e=1;e<o.annos;e++)a[e]=a[e-1]*i}var N=function(o,a){var c=Math.round(o/a*1e3)/10;return c},B=function(a,c){for(var i=0,e=0;e<o.vidaUtil;e++)i+=a[e]/Math.pow(1+c,e+1);return parseFloat(i.toFixed(2))},x=function(a,c){for(var i=a[0],e=1;e<o.vidaUtil;e++)i+=a[e]/Math.pow(1+c,e);return Math.round(100*i)/100},L=function(o){if(void 0!==o){var a,c=Math.pow(10,1),i=0,e=0,n=.1;o=o.map(Math.round);var s=0;s=x(o,e),a=s;do a=s,s=x(o,e),s>0?(n=a<0?.1*n:n,e+=n):(n=a>0?.1*n:n,e-=n),i++;while(i<5e4);return e*=100,Math.round(e*c)/c}},G={config:{},calculos:{calculoCashflowEscenarioConFV:u,calcularProductoArrayEntre100:r,calculoCosteCambioInversorConIVAActualizado:t,calculoCosteCambioInversorConIVA:s,calculoInteresesDelUsuarioParticular:d,calculoPagoInicial:p,calculoReduccionImpuestosSinFVEmpresa:c,calcularConIVAEInversion:m,calcularProductoIPC:f,calcularMultiplicacionSeisDatosEntre100:D,calcularRestaInvertido:H,eleccionTimeDiscrimination:I,calculoSumaProductosArray:A,calculoSumaProductos:P,calculoProductoFijoEntre100:E,calculoProductoEntre100:v,calculoSuma:h,calculoAsignacionProductoDatoFijo:a,calculoArrayDatoFijo:e,calculoResta:V,calculoSumaResta:j,calculoSumaArrayConDato:F,calculoN33UsuarioParticular:S,calculoConAsignacionDirecta:b,calculoConProducto:y,calculoConProductoEIncremento:T,calcularTIR:L,calcularVAN:B,calcularSumaMultiplicacionDosArrays:g,calcularMultiplicacionSeisDatosEntre100Unico:C,calcularPorcentajeDeEnergia:N,calculoDivisionProducto:U,calculoConProductoEIncrementoSoloCrecimiento:R,calculoProductoEntre100Fijo:_,calculoConProductoEIncrementoSoloIVA:w,devolverWithoutHD:i,calculoArrayEntreProducto:n,calculoCosteCambioInversorConIVAActualizadoParametros:l,calculoConProductoEIncrementoSoloIE:M},init:function(){}};return G}]),app.factory("modelFactory",["$http",function(o){var a="models/";return{getData:function(){return o({method:"GET",url:a+"inputs.model.json"})},getRegulatory:function(){return o({method:"GET",url:a+"inputRegulation.model.json"})},getEnergyFlows:function(){return o({method:"GET",url:a+"energyFlows.model.json"})},getImpactSelfConsumer:function(){return o({method:"GET",url:a+"impactSelfConsumer.model.json"})},getImpactElectricitySystem:function(){return o({method:"GET",url:a+"impactElectricitySystem.model.json"})},getImpactPublicFinances:function(){return o({method:"GET",url:a+"impactPublicFinances.model.json"})},getEnergyFlowsCalculation:function(){return o({method:"GET",url:a+"calculation/energyFlows.calc.model.json"})},getUsertype:function(){return o({method:"GET",url:a+"calculation/usertype.model.json"})},getTarifasData:function(){return o({method:"GET",url:a+"calculation/taxes.calc.model.json"})}}}]),app.controller("mainController",["$scope","calculoImpactOnPublicFinancesFactory","calculoImpactForTheElectricitySystemFactory","calculoImpactForTheSelfConsumerFactory","calculoImpactForTheElectricitySystemFactory","$rootScope","modelFactory",function(o,a,c,i,c,e,n){function s(){e.IVA=.21,e.IPC=.02,e.IE=5.11/100,e.producto=(1+e.IVA)*(1+e.IE),e.config={tableCode:"",tipoUsuario:"usuario_particular",tipoHacienda:"hacienda_particular"},e.vidaUtil=25,e.vidaUtilInversor=16,e.annos=35,e.datosTarifa={}}function t(){var o={cashflowAcumulado:[],IEElectricidadConsumidaFormaDiferida:{valor:[],sinDH:{valor:[],cuotaBN:[]},conDH:{valor:[],p1:[],p2:[],p3:[]}},IVAElectricidadAutoconsumidaDiferida:{valor:[],sinDH:{valor:[],IVASinCuotaBN:[],electricidadAutoconsumidaDeFormaDiferida:[]},conDH:{valor:[],p1:{cuotaBN:0,electricidadAutoconsumidaDeFormaDiferida:[]},p2:{cuotaBN:0,electricidadAutoconsumidaDeFormaDiferida:[]},p3:{cuotaBN:0,electricidadAutoconsumidaDeFormaDiferida:[]}}},IEElectricidadConsumida:{valor:[],sinDH:{valor:[],terminoDeEnergiaSinDH:[]},conDH:{valor:[],p1:[],p2:[],p3:[]}},recaudacionEscenarioSinFV:{valor:[],IVAAlquilerContador:{valor:[]},IEElectricidadConsumida:{valor:[],sinDH:{valor:[]},conDH:{valor:[]}},IVAElectricidadConsumida:{valor:[]},sinDH:{valor:[],IVATerminoEnergiaSinDH:[]},conDH:{valor:[],IVATerminoEnergiaConDH:{p1:[],p2:[],p3:[]}}},IVAElectricidadConsumida:{valor:[],conDH:{electricidadConsumida:{valor:[],p1:[],p2:[],p3:[]}},sinDH:{valor:[],terminoDeEnergiaSinDH:[],electricidadConsumida:0}},IVAPeajeRespaldo:{valor:[],valorBasePeajeRespaldo:[]},IVACostesOM:{valor:[],IVACostesOM:{valor:[],costesOM:0},IVACosteCambioInversorActualizado:{valor:[],IVACosteCambioInversor:0}},IVAAlquilerContador:{valor:[]},impuestoPrimasSeguros:{valor:[],costeSeguro:[]},IVAInversion:{valor:0,inversionSinIVA:0},ayudasPublicasALaInversion:{valor:0,porcentajeDeAyudasPublicas:0},incrementoImpuestoSociedadesInstalador:{valor:0},recaudacionEscenarioConFV:{valor:[]},diferenciaRecaudacion:{valor:[]},indicadores:{VAN:0,VANPorMWn:0,VANPorKWPVGenerado:0}},a={VANPagoPrincipal:0,VANGastosFinancieros:0,VANInversionInicial:0,VANCostesSeguro:0,VANAlquilerContador:0,VANCostesOM:0,VANEnergiaProducida:0,porcentajeDeAhorroDeEnergia:0,LCOE:0,TIR:0,energiaProducida:[],precioMedioElectricidadComprada:[],cashflowDelAhorroComparativoEnElCasoFV:[],costeElectricidadConsumida:[],cashflowEscenarioConFV:[],costeDeOM:[],indicadores:{cashflowAcumulado:[]},costePeajeRespaldoConImpuestos:{valor:[],sinDH:{costePeaje:[],terminoDeEnergiaConImpuestos:[],electricidadAutoconsumidaInstantaneamente:[]},conDH:{costePeajeRespaldoConImpuestos:[],terminoDeEnergiaDHConImpuestos:{p1:[],p2:[],p3:[]}}},calculoGastosFinancieros:{intereses:[],amortizacion:[],pagoInicial:[],saldo:[]},gastosFinancieros:[],costeElectricidadFVAutoconsumidaDiferida:[],inversionInicial:[],costesDeSeguro:[],costeElectricidadConsumidaSinFV:[],cashflowEscenarioSinFV:[],sinDH:{costeElectricidadConsumida:[],terminoDeEnergiaConImpuestos:[],electricidadAutoconsumidaInstantaneamente:[],electricidadAutoconsumidaDeFormaDiferida:[],costeElectricidadFVAutoconsumidaDiferida:[],electricidadExtraidaDeLaRed:[],electricidadConsumida:[],valor:[],cuotaBNConImpuestos:[]},conDH:{costeElectricidadConDH:[],costeElectricidadConsumida:[],costeElectricidadConsumidaSinFV:[],p1:{electricidadConsumida:[],consumo:[],terminoDeEnergiaSinImpuestos:[],cuotaBNConImpuestos:[],electricidadExtraidaDeLaRed:[],electricidadAutoconsumidaInstantaneamente:[],electricidadAutoconsumidaDeFormaDiferida:[],valor:[]},p2:{terminoDeEnergiaSinImpuestos:[],cuotaBNConImpuestos:[],electricidadAutoconsumidaInstantaneamente:[],electricidadAutoconsumidaDeFormaDiferida:[],electricidadExtraidaDeLaRed:[],electricidadConsumida:[],consumo:[],valor:[]},p3:{electricidadConsumida:[],consumo:[],terminoDeEnergiaSinImpuestos:[],cuotaBNConImpuestos:[],electricidadAutoconsumidaInstantaneamente:[],electricidadExtraidaDeLaRed:[],electricidadAutoconsumidaDeFormaDiferida:[],valor:[]}},costesOM:{costesOMConIVA:[]},alquiler_de_contador:[],alquiler_de_contadorConFV:[]};e.calculos={inputs:{alquilerDeContadores:{sinFV:10,conFV:20},informacionDeContorno:{sistema_electrico:{factorEmisionCO2:.41,precioToneladaCO2:15}},regulacionDelAutoconsumo:{pagosPorCapacidad:"No"},gastosFinancieros:{duracion:0,cantidadFinanciada:0,costeDeuda:0},caracteristicasTecnicas:{vidaUtilInversor:16,ratio:1.15,perdidaRendimientoAnual:.006},costesDeOM:0,costesOM:{costeCambioInversor:.3,costeCambioInversorConIVA:0,costeCambioInversorConIVAActualizado:[],disminucionDelCosteMaduracionTecnologica:.02,incrementoCosteInversorIPCMaduracion:0},inversionInicial:{inversionTotalConIVA:0},costePeajeRespaldoConImpuestos:{sinDH:{terminoDeEnergiaSinImpuestos:0},conDH:{terminoDeEnergiaDHConImpuestos:{p1:[],p2:[],p3:[]}}}},sistema_electrico:{ahorroEmisionCO2:0,impactoAnualParaSistemaElectricoMwn:{valor:0,impactoAnualSistemaElectricoEspanol:0,variacionIngresosPorPeajes:0},impactoPorPeajeDeRespaldo:0,ingresosEnergiaCedidaSistema:{valor:0,energiaCedida:0,precioPool:45},ingresosPorPeajeDeGeneracion:{valor:0,peajeDeGeneracion:.05,energiaVertidaALaRed:0},impactoPeajesBalanceNeto:{valor:0,sinDH:{valor:0,peajeBNSinDH:0},conDH:{valor:0,peajesDeBNConDH:{p1:0,p2:0,p3:0}}},impactoSobrecostesServiciosAjuste:{valor:0,sinDH:{valor:0,sobrecosteServiciosAjuste:0},conDH:{valor:0}},impactoPorPagosPorCapacidad:{valor:0,sinDH:{valor:0,pagosPorCapacidadSinDH:0},conDH:{valor:0,pagosPorCapacidadConDH:{p1:0,p2:0,p3:0}}},impactoPorLosPeajesDeAcceso:{valor:0,sinDH:{reduccionElectricidadComprada:0,valor:0,peajesDeAccesoSinDH:0},conDH:{valor:0,electricidadAutoconsumidaDeFormaDiferida:{p1:0,p2:0,p3:0},peajesAccesoConDH:{p1:0,p2:0,p3:0}}},conDH:{p1:{peajesDeBNConDH:0},p2:{peajesDeBNConDH:0},p3:{peajesDeBNConDH:0}},sinDH:{cuotaBN:0}},usuario_particular:a,usuario_empresa:a,hacienda_particular:o,hacienda_empresa:o}}function l(){o.outputs={},o.chartData={},o.chartOutputs={},o.chartOutputs.energyFlows={},o.chartOutputs.impactSelfConsumer={},o.chartOutputs.impactElectricitySystem={},o.chartOutputs.impactPublicFinances={},o.testInputEnergyFlows=[],o.testInputImpact=[],o.testInputImpact[0]=[],o.testInputImpact[0][0]=3,r()}function r(){n.getData().then(function(a){o.inputs=a.data.inputs,n.getRegulatory().then(function(a){o.inputRegulatory=a.data.regulatory,o.outputs.regulatory=o.inputRegulatory.options[0],n.getEnergyFlows().then(function(a){o.chartData.energyFlows=a.data.energyFlows,n.getImpactSelfConsumer().then(function(a){o.chartData.impactSelfConsumer=a.data.impactSelfConsumer,n.getImpactElectricitySystem().then(function(a){o.chartData.impactElectricitySystem=a.data.impactElectricitySystem,n.getImpactPublicFinances().then(function(a){o.chartData.impactPublicFinances=a.data.impactPublicFinances,n.getEnergyFlowsCalculation().then(function(a){o.energyFlowsCalculation=a.data,n.getTarifasData().then(function(a){o.tarifas=a.data,n.getUsertype().then(function(a){o.userType=a.data,u()},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})},function(o){console.log(o)})}o.init=function(){s(),l(),t(),o.$watch("outputs",function(a,c,i){o.outputs.generalChar&&o.outputs.modelParams&&o.energyFlowsCalculation&&o.inputs&&u()},!0),o.$watch("outputs.modelParams.excedentsToll",function(a,c,i){""!=c&&o.outputs.modelParams&&o.inputs&&o.outputs.generalChar&&o.energyFlowsCalculation&&u()}),o.$watch("outputs.generalChar.capacity.value",function(a,c,i){""!=c&&o.outputs.modelParams&&o.inputs&&o.outputs.generalChar&&o.energyFlowsCalculation&&u()}),o.$watch("outputs.modelParams.remuneration.value",function(a,c,i){o.outputs.modelParams&&o.inputs&&o.outputs.generalChar&&o.energyFlowsCalculation&&(3===a?(o.outputs.modelParams.rollingPeriod=o.inputs.modelParams[4].options[1],o.outputs.modelParams.exchange=o.inputs.modelParams[5].options[1]):(o.outputs.modelParams.rollingPeriod=o.inputs.modelParams[4].options[0],o.outputs.modelParams.exchange=o.inputs.modelParams[5].options[0]),u())}),o.$watch("outputs.regulatory.value",function(a,c,i){if(o.outputs.regulatory&&o.inputs)switch(a){case 0:o.outputs.modelParams.remuneration=o.inputs.modelParams[0].options[0],o.outputs.modelParams.backupToll=o.inputs.modelParams[1].options[1],o.outputs.modelParams.excedentsToll=100,o.outputs.modelParams.investmentAids=0;break;case 1:o.outputs.modelParams.remuneration=o.inputs.modelParams[0].options[1],o.outputs.modelParams.backupToll=o.inputs.modelParams[1].options[0],o.outputs.modelParams.excedentsToll=100,o.outputs.modelParams.investmentAids=0;break;case 2:o.outputs.modelParams.remuneration=o.inputs.modelParams[0].options[2],o.outputs.modelParams.backupToll=o.inputs.modelParams[1].options[0],o.outputs.modelParams.excedentsToll=30,o.outputs.modelParams.investmentAids=20}})};var u=function(){var n=o.outputs.generalChar.timeDiscrimination.value;"Company"==o.outputs.generalChar.legalStatus.name?(e.config.tipoUsuario="usuario_empresa",e.config.tipoHacienda="hacienda_empresa",e.producto=1+e.IE):(e.config.tipoUsuario="usuario_particular",e.config.tipoHacienda="hacienda_particular",e.producto=(1+e.IE)*(1+e.IVA)),e.config.tableCode=[o.outputs.generalChar.location.value,o.outputs.generalChar.consumerType.value,o.outputs.generalChar.capacity.value,o.outputs.modelParams.remuneration.value].join(""),o.chartOutputs.energyFlows.annualDemand=o.energyFlowsCalculation[e.config.tableCode].demand,o.chartOutputs.energyFlows.annualGeneration=o.energyFlowsCalculation[e.config.tableCode].production,o.chartOutputs.energyFlows.production=o.energyFlowsCalculation[e.config.tableCode].percentProduction,o.chartOutputs.energyFlows.electricityDemand=1===n?o.energyFlowsCalculation[e.config.tableCode].percentSelfVsDemandGlobal:o.energyFlowsCalculation[e.config.tableCode].percentSelfVsDemandBalance,o.chartOutputs.energyFlows.electricityInstantly=1===n?o.energyFlowsCalculation[e.config.tableCode].percentSelfConsumedInstantGlobal:o.energyFlowsCalculation[e.config.tableCode].percentSelfConsumedInstantBalance,o.chartOutputs.energyFlows.electricityManner=1===n?o.energyFlowsCalculation[e.config.tableCode].percentSelfConsumedDeferredGlobal:o.energyFlowsCalculation[e.config.tableCode].percentSelfConsumedDeferredBalance,o.chartOutputs.energyFlows.electricitySold=1===n?o.energyFlowsCalculation[e.config.tableCode].percentSoldGlobal:o.energyFlowsCalculation[e.config.tableCode].percentSoldBalance,o.chartOutputs.energyFlows.electricityLost=1===n?o.energyFlowsCalculation[e.config.tableCode].percentLostGlobal:o.energyFlowsCalculation[e.config.tableCode].percentLostBalance,o.testInputEnergyFlows=[o.energyFlowsCalculation[e.config.tableCode].selfConsumedInstant,o.energyFlowsCalculation[e.config.tableCode].selfConsumedDeferred,o.energyFlowsCalculation[e.config.tableCode].sold,o.energyFlowsCalculation[e.config.tableCode].lost],e.objetoTabla=o.energyFlowsCalculation[e.config.tableCode],e.datosTarifa=o.tarifas[o.outputs.generalChar.consumerType.name],e.userType=o.userType[o.outputs.generalChar.consumerType.name],e.userType.llaveEnMano=""==o.outputs.generalChar.epc?0:parseFloat(o.outputs.generalChar.epc),e.outputs=o.outputs,e.outputs.generalChar.annualRate=""==o.outputs.generalChar.annualRate?0:parseFloat(o.outputs.generalChar.annualRate),o.testInputEnergyFlows[0]=[e.objetoTabla.selfConsumedInstant],"1"==e.outputs.generalChar.timeDiscrimination.value?(o.testInputEnergyFlows[1]=e.objetoTabla.summarySelfConsumedDeferredGlobal,o.testInputEnergyFlows[2]=e.objetoTabla.summarySoldGlobal,o.testInputEnergyFlows[3]=e.objetoTabla.summaryLostGlobal):(o.testInputEnergyFlows[1]=e.objetoTabla.summarySelfConsumedDeferredBalance,o.testInputEnergyFlows[2]=e.objetoTabla.summarySoldBalance,o.testInputEnergyFlows[3]=e.objetoTabla.summaryLostBalance);var s=new Promise(function(o,a){i.init(),o(1)});s.then(function(){e.calculos[e.config.tipoUsuario].TIR=i.calculos.calcularTIR(e.calculos[e.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV),o.testInputImpact[0][0]=e.calculos[e.config.tipoUsuario].TIR,o.chartData.impactSelfConsumer[0].valor=e.calculos[e.config.tipoUsuario].TIR,e.calculos[e.config.tipoUsuario].VAN=i.calculos.calcularVAN(e.calculos[e.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV,e.userType.tasaDescuentoUsuario),o.chartData.impactSelfConsumer[1].valor=e.calculos[e.config.tipoUsuario].VAN,e.calculos[e.config.tipoUsuario].porcentajeDeAhorroDeEnergia=-i.calculos.calcularPorcentajeDeEnergia(e.calculos[e.config.tipoUsuario].cashflowDelAhorroComparativoEnElCasoFV[1],e.calculos[e.config.tipoUsuario].cashflowEscenarioSinFV[1]),o.chartData.impactSelfConsumer[2].valor=e.calculos[e.config.tipoUsuario].porcentajeDeAhorroDeEnergia;var n=e.calculos[e.config.tipoUsuario].indicadores.cashflowAcumulado.filter(function(o){return o<0});o.chartData.impactSelfConsumer[3].valor=0==n.length?n.length:n.length,o.chartData.impactSelfConsumer[4].valor=Math.round(10*e.calculos[e.config.tipoUsuario].precioMedioElectricidadComprada[0])/10,o.chartData.impactSelfConsumer[5].valor=e.calculos[e.config.tipoUsuario].LCOE,o.$apply();var s=new Promise(function(o,a){c.init(),o(1)}),t=new Promise(function(o,c){a.init(),o(1)});s.then(function(){o.chartData.impactElectricitySystem[0].valor=e.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.impactoAnualSistemaElectricoEspanol,o.chartData.impactElectricitySystem[1].valor=e.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.valor,o.chartData.impactElectricitySystem[2].valor=e.calculos.sistema_electrico.impactoAnualParaSistemaElectricoMwn.variacionIngresosPorPeajes,o.chartData.impactElectricitySystem[3].valor=e.calculos.sistema_electrico.ahorroEmisionCO2,o.$apply(),t.then(function(){o.chartData.impactPublicFinances[0].valor=e.calculos[e.config.tipoHacienda].indicadores.VANPorMWn,o.chartData.impactPublicFinances[1].valor=e.calculos[e.config.tipoHacienda].indicadores.VANPorKWPVGenerado,o.testPublicFinances=e.calculos[e.config.tipoHacienda].cashflowAcumulado;var a=[];if("usuario_empresa"==e.config.tipoUsuario)for(var c=0;c<e.calculos[e.config.tipoHacienda].cashflowAcumulado.length&&e.calculos[e.config.tipoHacienda].cashflowAcumulado[c]>0;)a.push(e.calculos[e.config.tipoHacienda].cashflowAcumulado[c]),c++;else a=e.calculos[e.config.tipoHacienda].cashflowAcumulado.filter(function(o){return o>0});o.chartData.impactPublicFinances[2].valor=0==a.length?a.length:a.length,o.$apply()})})})}}]),app.directive("energyFlows",function(){return{scope:!0,restrict:"AE",templateUrl:"./templates/charts/energyFlows.view.html",link:function(o){function a(){var a=["Self Inst.","Self Defer.","Sales to pool","Losses"],c=o.testInputEnergyFlows,i=["#f9b000","#3aaa35"],e=Math.max.apply(Math,c),n=615,s=d3.scale.linear().domain([10,e]).range([0,n-150]),t=d3.scale.linear().domain([a.length,0]).range([230,0]),l=d3.scale.quantize().domain([0,a.length]).range(i),r=d3.select("#energyFlows").append("svg").attr({width:n,height:250}),u=d3.svg.axis();u.orient("bottom");var d=d3.svg.axis();d.orient("left").scale(t).tickSize(0).tickFormat(function(o,c){return a[c]}).tickValues(d3.range(4));var p=(r.append("g").attr("transform","translate(120,40)").attr("id","yaxis").call(d),r.append("g").attr("transform","translate(120,0)").attr("id","bars").selectAll("rect").data(c).enter().append("rect").attr("height",40).attr({x:0,y:function(o,a){return t(a)+20}}).style("fill",function(o,a){return l(a)}).attr("width",function(o){return 0}),d3.select("svg").selectAll("rect").data(c).attr("width",function(o){return s(o)+10}),d3.select("#bars").selectAll("text").data(c).enter().append("text").attr({x:function(o){var a=0;return a=s(o)-75<20?20:s(o)-75},y:function(o,a){return t(a)+45}}).text(function(o){return o+" kWh"}).style({fill:function(o){var a="#fff";return o<1500&&(a="#343434"),a},"font-size":"14px"}),d3.selectAll(".tick").append("line"));p.attr("x1",500).attr("y",40).attr("y1",0).attr("x",30).style("stroke","rgb(195, 195, 195)");var m=d3.selectAll("#bars > rect"),f=d3.selectAll(".tick > text");f.attr("x","-10");var g=d3.selectAll([m[0][1],m[0][3]]);g.attr("style","display:none");var D=d3.selectAll("#bars > text"),C=d3.selectAll([D[0][1],D[0][3]]);C.style("display","none");var H=d3.select("#energyFlows").append("div"),I=d3.select("#energyFlows").append("div");H.attr("class","dataFlowBar").html("<p>"+c[1]+" kWh</p>").style("top","74px").style("left","120px"),I.attr("class","dataFlowBar").html("<p>"+c[3]+" kWh</p>").style("top","190px").style("left","120px")}o.$watchCollection("testInputEnergyFlows",function(o,c,i){o!==c&&(d3.select("#energyFlows > svg").remove(),d3.selectAll(".dataFlowBar").remove(),a())}),a()}}}),app.directive("convertPercentage",function(){return{require:"ngModel",link:function(o,a,c,i){var e=function(o){return parseFloat(o||"")};i.$parsers.unshift(e)}}}),app.directive("publicFinances",function(){return{scope:!0,restrict:"AE",templateUrl:"./templates/charts/publicFinances.view.html",link:function(o){function a(){if(o.testPublicFinances&&o.testPublicFinances.length>0){var a=o.testPublicFinances,n=Math.max.apply(Math,a),s=Math.min.apply(Math,a),t=d3.scale.linear().domain([1,a.length]).range([1,i]),l=d3.scale.linear().domain([1e3*Math.floor(s/1e3),1e3*Math.ceil(n/1e3)]).range([e,0]),r=d3.svg.line().x(function(o,a){return t(a)}).y(function(o){return l(o)}),u=(d3.selectAll("#publicFinances").append("div").attr("class","eur-legend").attr("style","height:"+e+"px").html("<p class='bold'></p>"),d3.selectAll("#publicFinances").append("svg").attr("width",i+c[1]+c[3]).attr("height",e+c[0]+c[2]).append("svg:g").attr("transform","translate("+c[3]+","+c[0]+")")),d=d3.svg.axis().scale(t).tickSize(-e).ticks(4).tickSubdivide(!0);u.append("svg:g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(d);var p=d3.svg.axis().scale(l).tickSize(-i).orient("left");u.append("svg:g").attr("class","y axis").attr("transform","translate(0,0)").call(p);var m=(u.append("svg:path").attr("d",r(a)).attr("transform","translate(15,-1)"),d3.selectAll(".y.axis > .tick > text").attr("class",function(o){return 0==o?"text-cero-cum":o>0?"text-pos-cum":"text-neg-cum"}).attr("x","-16"),d3.select("#publicFinances").append("div").attr("class","tooltip").style("display","none")),f=d3.svg.axis().scale(t).tickSize(-e).ticks(a.length);u.append("svg:g").attr("class","x axisHover").attr("transform","translate(0,"+e+")").call(f);var g=r(a).split(","),D=d3.selectAll(".axisHover > g");D.on("mouseover",function(o,c){var i=this.getAttribute("transform").split("("),e=i[1].split(")"),n=e[0].split(","),s=n[0];m.html('<span class="bold">'+(c+1)+" years</span><br><span>"+a[c]+" </span>").attr("style","display:block;top:"+(Math.round(g[c].substring(0,4))+24)+"px;"+("left:"+(140+Math.round(s))+"px;"))}).on("mouseout",function(){m.style("display","none")})}}var c=[20,30,20,140],i=670-c[1]-c[3],e=300-c[0]-c[2];o.$watchCollection("testPublicFinances",function(o,c,i){o!==c&&(d3.selectAll("#publicFinances > svg").remove(),a())}),a()}}}),app.directive("selfConsumer",function(){return{scope:!0,restrict:"AE",templateUrl:"./templates/charts/selfConsumer.view.html",link:function(o){function a(){var a=o.testInputImpact,e=Math.max.apply(Math,a),n={top:20,right:0,bottom:30,left:110},s=590-n.left-n.right,t=200-n.top-n.bottom,l=d3.scale.linear().domain([1.5*-e,1.5*e]).range([t,0]),r=d3.scale.ordinal().domain(d3.range(c)).rangeBands([0,s],.3),u=d3.scale.ordinal().range([e>=0?"#3aaa35":"red"]),d=d3.scale.ordinal().range(["w","wo"]),p=d3.scale.ordinal().domain(d3.range(i)).rangeBands([0,r.rangeBand()]),m=(d3.svg.axis().scale(r).tickSize(0).tickPadding(6).orient("bottom"),d3.svg.axis().ticks(4).scale(l).orient("left")),f=d3.select("body").select("#selfConsumer").append("svg").attr("class","chart-svg-electricity-bill chart-svg").attr("width",s+n.left+n.right).attr("height",t+n.top+n.bottom).append("svg:g").attr("transform","translate("+n.left+","+n.top+")");f.append("g").attr("class","axis-bottom y axis-cumulated").call(m),f.selectAll(".axis-cumulated > .tick > line").attr("x2",s),f.selectAll(".axis-cumulated > .tick > text").html(function(o,a){return o+"%"}),f.append("g").selectAll("g").data(a).enter().append("g").style("fill",function(o,a){return u(a)}).attr("class",function(o,a){return d(a)}).attr("transform",function(o,a){return"translate("+p(a)+",0)"}).selectAll("rect").data(function(o){return o}).enter().append("rect").attr("width",p.rangeBand()).attr("height",function(o){return Math.abs(l(o)-l(0))}).attr("x",function(o,a){return r(a)}).attr("y",function(o){return l(Math.max(0,o))}),f.selectAll(".w ").append("text").style("fill","#fff").style("font-family","'Myriad Pro Semibold'").attr("x",function(o,a){return r(a)+p.rangeBand()/2-30}).attr("y",function(o){return l(Math.max(0,o))+18}).html(function(o,a){return o+"%";
});f.selectAll(".w")}var c=1,i=1;o.$watchCollection("testInputImpact[0]",function(o,c,i){o!==c&&(d3.select("#selfConsumer > svg").remove(),a())}),a()}}});